name: CI
on: push
jobs:
  bash:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Add Go bin directory to GitHub Path (non-Windows)
        if: ${{ matrix.os != 'windows-latest' }}
        run: echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Add Go bin directory to GitHub Path (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: >
          "$env:HOMEDRIVE/$env:HOMEPATH/go/bin"
          | Out-File -FilePath $env:GITHUB_PATH -Append
      - name: Set Git autocrlf (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: git config --global core.autocrlf input
      - name: Install shfmt
        run: |
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          shfmt --version
      - name: Install shellcheck (Ubuntu)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install shellcheck
      - name: Install shellcheck (macOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          brew update
          brew install shellcheck
      - name: Install shellcheck (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: choco install shellcheck
      - name: Get shellcheck version
        run: shellcheck --version
      - name: Install Bash
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          brew update
          brew install bash
      - name: Get Bash version
        run: bash --version
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Run shfmt
        shell: bash
        run: |
          source ./src/ci.sh
          run_ci_bash_shfmt
      - name: Run shellcheck
        shell: bash
        run: |
          source ./src/ci.sh
          run_ci_bash_shellcheck
